<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GeoPhoto - Marcação de Fotos</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body {
      background: linear-gradient(135deg,#6a11cb 0%,#2575fc 100%);
      min-height:100vh; display:flex; justify-content:center; align-items:center; padding:20px;
    }
    .container {
      width:100%; max-width:500px; background:#fff; border-radius:20px; overflow:hidden;
      box-shadow:0 10px 30px rgba(0,0,0,.2);
    }
    header { text-align:center; padding:20px; background:#4285f4; color:#fff; }
    h1 { font-size:1.8rem; margin-bottom:5px; }
    .subtitle { font-size:1rem; opacity:.9; }
    .camera-container { background:#000; width:100%; height:350px; position:relative; overflow:hidden; }
    #video { width:100%; height:100%; object-fit:cover; }
    .camera-overlay {
      position:absolute; bottom:10px; left:10px; background:rgba(0,0,0,.5);
      color:#fff; padding:5px 10px; border-radius:5px; font-size:.8rem;
    }
    .shutter-btn-container { display:flex; justify-content:center; padding:20px; background:#f8f9fa; gap:15px; }
    #shutter-btn, #switch-camera {
      width:70px; height:70px; border-radius:50%; border:4px solid #4285f4;
      background:#fff; cursor:pointer; display:flex; justify-content:center; align-items:center;
      box-shadow:0 5px 15px rgba(0,0,0,.2); transition:.3s;
    }
    #switch-camera { width:50px; height:50px; border:3px solid #666; }
    #shutter-btn:active { transform:scale(.95); }
    #shutter-btn::before { content:''; width:50px; height:50px; border-radius:50%; background:#4285f4; }
    .location-data { padding:20px; border-bottom:1px solid #eee; }
    .location-data p { margin-bottom:10px; display:flex; align-items:center; gap:10px; }
    .location-data i { color:#4285f4; width:20px; }
    .action-buttons { display:flex; padding:20px; gap:15px; background:#f8f9fa; flex-wrap:wrap; }
    .action-btn {
      flex:1; padding:15px; border:none; border-radius:10px; font-weight:600; cursor:pointer;
      display:flex; justify-content:center; align-items:center; gap:10px; transition:.3s;
      box-shadow:0 3px 10px rgba(0,0,0,.1);
    }
    .download-btn { background:#4caf50; color:#fff; }
    .download-btn:hover { background:#3d8b40; }
    .whatsapp-btn { background:#25d366; color:#fff; }
    .whatsapp-btn:hover { background:#128c7e; }
    .gallery { padding:20px; }
    .gallery h2 { margin-bottom:15px; text-align:center; color:#4285f4; }
    .photo-list { display:grid; grid-template-columns:repeat(2,1fr); gap:15px; }
    .photo-item { position:relative; border-radius:10px; overflow:hidden; box-shadow:0 3px 10px rgba(0,0,0,.1); }
    .photo-item img { width:100%; height:150px; object-fit:cover; }
    .photo-info { position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,.7); color:#fff; padding:5px; font-size:.7rem; }
    .permission-msg { text-align:center; padding:20px; background:#ffebee; color:#c62828; }
    #permission-btn { margin-top:10px; padding:10px 20px; border:none; background:#4285f4; color:#fff; border-radius:8px; cursor:pointer; }
    @media(max-width:500px){ .photo-list{ grid-template-columns:1fr;} .action-buttons{ flex-direction:column;} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>GeoPhoto</h1>
      <p class="subtitle">Marque suas fotos com localização, data e hora</p>
    </header>

    <div id="permission-section" class="permission-msg">
      <p><i class="fas fa-lock"></i> Para usar o app, permita acesso à câmera e localização.</p>
      <button id="permission-btn">Permitir acesso</button>
    </div>

    <div class="camera-container">
      <video id="video" autoplay playsinline></video>
      <div class="camera-overlay">
        <i class="fas fa-map-marker-alt"></i> <span id="location-status">Obtendo localização...</span>
      </div>
    </div>

    <div class="shutter-btn-container">
      <button id="shutter-btn"></button>
      <button id="switch-camera"><i class="fas fa-sync"></i></button>
    </div>

    <div class="location-data">
      <p><i class="fas fa-clock"></i> <span id="date-time">--/--/---- --:--:--</span></p>
      <p><i class="fas fa-map-marker-alt"></i> <span id="coordinates">Lat: --, Lng: --</span></p>
      <p><i class="fas fa-location-arrow"></i> <span id="address">Obtendo endereço...</span></p>
    </div>

    <div class="action-buttons">
      <button id="download-all" class="action-btn download-btn" disabled>
        <i class="fas fa-download"></i> Baixar todas
      </button>
      <button class="action-btn whatsapp-btn" id="share-all" disabled>
        <i class="fab fa-whatsapp"></i> Compartilhar todas
      </button>
    </div>

    <div class="gallery">
      <h2>Fotos Recentes</h2>
      <div class="photo-list" id="photo-list"></div>
    </div>
  </div>

  <script>
    const video=document.getElementById('video');
    const shutterBtn=document.getElementById('shutter-btn');
    const switchBtn=document.getElementById('switch-camera');
    const dateTimeElement=document.getElementById('date-time');
    const coordinatesElement=document.getElementById('coordinates');
    const addressElement=document.getElementById('address');
    const photoList=document.getElementById('photo-list');
    const locationStatus=document.getElementById('location-status');
    const downloadAllBtn=document.getElementById('download-all');
    const shareAllBtn=document.getElementById('share-all');
    const permissionBtn=document.getElementById('permission-btn');
    const permissionSection=document.getElementById('permission-section');

    let stream=null, currentLocation=null, watchId=null;
    let currentPhotoData=null, usingFront=false;
    let photos=[]; const MAX_PHOTOS=5;

    async function init(){
      try{
        await Promise.all([initCamera(), initGeolocation()]);
        setInterval(updateDateTime,1000); updateDateTime();
        permissionSection.style.display="none";
      }catch(err){ console.error(err); permissionSection.style.display="block"; }
    }

    async function initCamera(){
      stream=await navigator.mediaDevices.getUserMedia({
        video:{facingMode: usingFront?"user":"environment", width:{ideal:1920}, height:{ideal:1080}}, audio:false
      });
      video.srcObject=stream;
    }

    async function initGeolocation(){
      if(!navigator.geolocation) throw new Error("Geolocalização não suportada");
      return new Promise((resolve,reject)=>{
        navigator.geolocation.getCurrentPosition(pos=>{
          updateLocation(pos); locationStatus.textContent="Localização obtida"; resolve();
        },err=>{ addressElement.textContent="Erro ao obter localização"; reject(err); },
        {enableHighAccuracy:true,timeout:10000});
        watchId=navigator.geolocation.watchPosition(updateLocation,()=>{}, {enableHighAccuracy:true});
      });
    }

    function updateLocation(pos){
      currentLocation=pos;
      const {latitude,longitude}=pos.coords;
      coordinatesElement.textContent=`Lat: ${latitude.toFixed(6)}, Lng: ${longitude.toFixed(6)}`;
      locationStatus.textContent=`Lat: ${latitude.toFixed(4)}, Lng: ${longitude.toFixed(4)}`;
      getAddressFromCoords(latitude,longitude);
    }

    async function getAddressFromCoords(lat,lng){
      try{
        const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&namedetails=1`);
        const data=await r.json();
        let place="Endereço não disponível";
        if(data.namedetails && data.namedetails.name) place=data.namedetails.name;
        else if(data.address && data.address.amenity) place=data.address.amenity;
        else if(data.display_name) place=data.display_name.split(",").slice(0,3).join(",");
        addressElement.textContent=place;
      }catch{ addressElement.textContent="Erro ao obter endereço"; }
    }

    function updateDateTime(){ dateTimeElement.textContent=new Date().toLocaleString("pt-BR"); }

    shutterBtn.addEventListener("click",()=>{
      if(!currentLocation){ alert("Aguardando localização..."); return; }
      if(photos.length>=MAX_PHOTOS){ alert("Limite de "+MAX_PHOTOS+" fotos atingido."); return; }
      setTimeout(capturePhoto,150);
    });

    function capturePhoto(){
      const canvas=document.createElement("canvas");
      canvas.width=video.videoWidth; canvas.height=video.videoHeight;
      const ctx=canvas.getContext("2d");
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const now=new Date(), dateTime=now.toLocaleString("pt-BR");
      const {latitude,longitude}=currentLocation.coords;
      ctx.fillStyle="rgba(0,0,0,.7)";
      ctx.fillRect(10,canvas.height-110,canvas.width-20,100);
      ctx.fillStyle="#fff"; ctx.font="16px Arial";
      ctx.fillText(dateTime,20,canvas.height-85);
      ctx.fillText(`Lat: ${latitude.toFixed(6)}`,20,canvas.height-60);
      ctx.fillText(`Lng: ${longitude.toFixed(6)}`,20,canvas.height-35);
      ctx.fillText(addressElement.textContent,20,canvas.height-10);
      currentPhotoData=canvas.toDataURL("image/jpeg");
      photos.push({image:currentPhotoData, dateTime, lat:latitude, lng:longitude});
      addToGallery(currentPhotoData,dateTime,latitude,longitude);
      downloadAllBtn.disabled=false; shareAllBtn.disabled=false;
    }

    function addToGallery(img,dateTime,lat,lng){
      const item=document.createElement("div"); item.className="photo-item";
      item.innerHTML=`<img src="${img}" alt="Foto"><div class="photo-info">
        <div>${dateTime}</div><div>Lat:${lat.toFixed(4)} Lng:${lng.toFixed(4)}</div></div>`;
      photoList.insertBefore(item,photoList.firstChild);
    }

    downloadAllBtn.addEventListener("click",()=>{
      photos.forEach((p,i)=>{
        const a=document.createElement("a");
        a.href=p.image; a.download=`geo_photo_${i+1}.jpg`;
        document.body.appendChild(a); a.click(); a.remove();
      });
    });

    shareAllBtn.addEventListener("click",async()=>{
      try{
        const files=await Promise.all(photos.map((p,i)=>
          fetch(p.image).then(r=>r.blob()).then(b=>new File([b],`foto_${i+1}.jpg`,{type:"image/jpeg"}))
        ));
        const data={files,title:"Fotos GeoPhoto"};
        if(navigator.canShare && navigator.canShare(data)) await navigator.share(data);
        else alert("Compartilhamento múltiplo não suportado neste navegador.");
      }catch(e){ console.error(e); }
    });

    switchBtn.addEventListener("click",async()=>{
      usingFront=!usingFront;
      if(stream) stream.getTracks().forEach(t=>t.stop());
      await initCamera();
    });

    permissionBtn.addEventListener("click",init);
  </script>
</body>
</html>
